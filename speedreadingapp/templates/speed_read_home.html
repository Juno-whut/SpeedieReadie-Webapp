{% extends 'layout.html' %}
{% load static %}

{% block title %}
    Speed Reading
{% endblock %}

{% block content %}
    <h2>Speed Reading</h2>
    <div class="container">
        <div class="reader">
            <div id="display-area" class="display-area"></div>
            <div class="controls">
                <button id="new" onclick="newText()">New</button>
                <button id="play-pause" onclick="playPauseReading()">Play/Pause</button>
                <button id="reset" onclick="resetReading()">Reset</button>
                <button id="settings" onclick="openSettings()">Settings</button>
            </div>
        </div>
        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSettings()">&times;</span>
                <h3>Settings</h3>
                <div class="setting"> 
                    <label for="wpm">Speed (WPM):</label>
                    <input type="number" id="wpm" value="300" min="0">
                </div>
                    <div class="setting">
                    <label for="words-at-once">Chunk Size (words):</label>
                    <select id="words-at-once">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                    </select>
                </div>
                <div class="setting"> 
                    <label for="font-size">Font Size (px):</label>
                    <select id="font-size">
                        <option value="30">30</option>
                        <option value="40">40</option>
                        <option value="50">50</option>
                        <option value="60">60</option>
                        <option value="70">70</option>
                        <option value="80">80</option>
                    </select>
                </div>
                <div class="setting">
                    <label for="text-color">Text Color:</label>
                    <input type="color" id="text-color" value="#000000">
                </div>
                <div class="setting">
                    <label for="background-color">Background Color:</label>
                    <input type="color" id="background-color" value="#ffffff">
                </div>
                <button id="apply-settings" onclick="applySettings()">Apply</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let readingInterval = null;
    let words = [];
    let currentWordIndex = 0;
    let isPlaying = false;

    function displayWord() {
        if (currentWordIndex < words.length) {
            document.getElementById('display-area').innerText = words[currentWordIndex];
            currentWordIndex++;
        } else {
            clearInterval(readingInterval);
            isPlaying = false;
        }
    }

    function startReading() {
        const wpm = document.getElementById('wpm').value;
        const interval = 60000 / wpm;
        readingInterval = setInterval(displayWord, interval);
        isPlaying = true;
    }

    function playPauseReading() {
        if (isPlaying) {
            clearInterval(readingInterval);
            isPlaying = false;
        } else {
            startReading();
        }
    }

    function restartReading() {
        clearInterval(readingInterval);
        currentWordIndex = 0;
        startReading();
    }

    function areHotkeysEnabled() {
        if (document.getElementById('settings-modal').style.display != 'none') {
            return false;
        }

        return true;
    }
    function openSettings() {
        document.getElementById('settings-modal').style.display = 'block';
    }

    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }

    function applySettings() {
        const displayArea = document.getElementById("display-area");
        displayArea.style.fontSize = document.getElementById("font-size").value + 'px';
        displayArea.style.color = document.getElementById("text-color").value;
        displayArea.style.backgroundColor = document.getElementById("background-color").value;
        closeSettings();
        if (isPlaying) {
            clearInterval(readingInterval);
            startReading();
        }
    }

    function newText() {
        location.reload();
    }

    function adjustWpm(increment) {        
        const wpmInput = document.getElementById('wpm');        
        wpmInput.value = parseInt(wpmInput.value) + increment;        
        if (isPlaying) {            
            clearInterval(readingInterval);
            startReading();            
        }
    }

    document.addEventListener('keydown', function(event) {
        if (!areHotkeysEnabled()) return;
        const hotkeys = new Map([
            ['n', newText],
            ['p', playPauseReading],
            ['r', restartReading],
            ['ArrowUp', () => adjustWpm(25)],
            ['ArrowDown', () => adjustWpm(-25)],
            ['s', openSettings],
        ]);
        func = hotkeys.get(event.key);
        if (func) {
            func();
        } else {
            console.log("Unrecognized hotkey: " + event.key);
        }
    });

    document.addEventListener("DOMContentLoaded", function() {
        const text = "{{ request.POST.text|escapejs }}";
        words = text.split(/\s+/);
        document.getElementById("display-area").textContent = words[0] || '';
    });
</script>
{% endblock %}
